<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞</title>
<style>
  :root{
    --bg1:#efeae3;
    --card:#ffffff;
    --muted:#6b6f74;
    --accent:#b88646; /* –º—è–≥–∫–æ–µ –∑–æ–ª–æ—Ç–æ */
    --accent-strong:#9a6f3a;
    --shadow: 0 8px 30px rgba(19,18,17,0.08);
    --green:#2f8f6e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,var(--bg1), #f6f3ee);
    -webkit-font-smoothing:antialiased; color:#1b1b1b;
    display:flex; align-items:flex-start; justify-content:center; padding:36px;
    min-height:100vh;
  }

  .wrap{width:100%;max-width:980px;display:flex;gap:28px;align-items:flex-start}
  .card{
    background:var(--card); border-radius:14px; padding:26px; box-shadow:var(--shadow); flex:0 0 520px;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{transform:translateY(-4px)}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:6px}
  .title-block{flex:1}
  h1{margin:0;font-size:20px;letter-spacing:0.2px;font-weight:600;color:#222}
  .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px}
  .lang-row{display:flex;align-items:center;gap:8px}
  .flag-btn{border:0;background:transparent;padding:6px;border-radius:8px;font-size:20px;cursor:pointer;transition:transform .15s, box-shadow .15s}
  .flag-btn:hover{transform:translateY(-3px); box-shadow:0 6px 18px rgba(154,111,58,0.12)}
  .flag-btn.active{box-shadow:inset 0 -2px 0 rgba(154,111,58,0.12); border-radius:8px}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6e2dc;background:transparent;font-size:15px;color:#111}
  select:focus,input:focus{outline:none;box-shadow:0 6px 18px rgba(154,111,58,0.08);border-color:rgba(154,111,58,0.18)}
  .full{grid-column:1 / -1}
  .direction{display:flex;gap:8px;align-items:center}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #eee;background:linear-gradient(180deg,#fff,#fbfaf8);cursor:pointer;font-weight:600;color:#333}
  .pill.active{background:linear-gradient(180deg,#fff8f1,#fff2e6);border:1px solid rgba(154,111,58,0.18);box-shadow:0 6px 18px rgba(154,111,58,0.06)}
  .result-card{margin-top:18px;background:linear-gradient(180deg,#fff,#fff);border-radius:12px;padding:16px;border:1px solid #f0ebe6}
  .row{display:flex;justify-content:space-between;align-items:center;padding:10px 4px}
  .label{color:var(--muted);font-size:13px}
  .value{font-size:18px;font-weight:700;color:#111}
  .value.editable{cursor:text;padding:6px 10px;border-radius:8px;min-width:140px;text-align:right}
  .value.editable:focus{outline:none;box-shadow:0 6px 18px rgba(154,111,58,0.06)}
  .small{font-size:12px;color:var(--muted);margin-top:6px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
  .muted-block{font-size:13px;color:var(--muted);margin-top:8px}
  .right-col{flex:1}
  .hint{font-size:12px;color:#8b8f94}
  .footer{margin-top:14px;font-size:12px;color:var(--muted);text-align:center}

  /* number animation */
  .num-wrap{display:inline-block;overflow:hidden;height:28px}
  .num{display:inline-block;transform:translateY(0);transition:transform .22s cubic-bezier(.2,.9,.2,1),opacity .18s}
  .num-out{transform:translateY(6px);opacity:0}

  /* responsive */
  @media (max-width:860px){
    .wrap{flex-direction:column;align-items:stretch}
    .card{flex:unset}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Currency calculator">
      <header>
        <div class="title-block">
          <h1 id="title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞</h1>
          <div class="subtitle" id="subtitle">–ë—ã—Å—Ç—Ä—ã–π –∏ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏</div>
        </div>

        <div class="lang-row" aria-hidden="false">
          <div style="text-align:right">
            <button class="flag-btn active" id="flag-ru" title="–†—É—Å—Å–∫–∏–π (RU)">üá∑üá∫</button>
            <button class="flag-btn" id="flag-cn" title="‰∏≠Êñá (CN)">üá®üá≥</button>
          </div>
        </div>
      </header>

      <div style="margin-top:8px" class="hint" id="hint-line">–ù–∞–ø—Ä–∏–º–µ—Ä: 11.3 –∏–ª–∏ 0.0884 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞</div>

      <div class="controls" style="margin-top:14px">
        <div>
          <label id="lbl-direction">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
          <div class="direction" role="radiogroup" aria-labelledby="lbl-direction">
            <button class="pill active" id="dir-rub2cny" data-dir="rub2cny">–ö => ÂÖÉ</button>
            <button class="pill" id="dir-cny2rub" data-dir="cny2rub">ÂÖÉ => K</button>
          </div>
        </div>

        <div>
          <label id="lbl-your-rate">–í–∞—à –∫—É—Ä—Å</label>
          <input id="myRate" inputmode="decimal" placeholder="11.3" />
        </div>

        <div>
          <label id="lbl-client-rate">–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫—É—Ä—Å</label>
          <input id="clientRate" inputmode="decimal" placeholder="11.8" />
        </div>

        <div>
          <label id="lbl-amount">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É</label>
          <input id="amount" inputmode="decimal" placeholder="500000" />
        </div>

        <div class="full">
          <div class="muted-block">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤–≤–æ–¥ —á–∏—Å–µ–ª —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π –∏ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>
        </div>
      </div>

      <div class="result-card" id="results">
        <div class="row" style="align-items:flex-start">
          <div>
            <div class="label" id="lab-client-get">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç</div>
            <div tabindex="0" contenteditable="true" id="clientGet" class="value editable" role="textbox" aria-label="–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç">‚Äî</div>
          </div>
          <div style="text-align:right">
            <div class="label" id="lab-client-give-label">–ö–ª–∏–µ–Ω—Ç –æ—Ç–¥–∞—Å—Ç</div>
            <div tabindex="0" contenteditable="true" id="clientGive" class="value editable" role="textbox" aria-label="–ö–ª–∏–µ–Ω—Ç –æ—Ç–¥–∞—Å—Ç">‚Äî</div>
          </div>
        </div>

        <div class="row" style="border-top:1px dashed #f0ebe6;margin-top:8px;padding-top:12px">
          <div>
            <div class="label">–í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å (‚ÇΩ)</div>
            <div class="value" id="profitRub">‚Äî</div>
          </div>
          <div style="text-align:right">
            <div class="label">–í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å (ÂÖÉ)</div>
            <div class="value" id="profitCny">‚Äî</div>
          </div>
        </div>

        <div class="note" id="detailLine">‚Äî</div>
      </div>

      <div class="footer">–§–æ—Ä–º–∞—Ç –∫—É—Ä—Å–æ–≤: >1 ‚Äî —Ä—É–±/—é–∞–Ω—å, &lt;1 ‚Äî —é–∞–Ω—å/—Ä—É–±–ª—å (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</div>
    </div>
  </div>

<script>
/* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
function cleanNum(s){
  if (s === null || s === undefined) return NaN;
  s = String(s).trim();
  if (s === "") return NaN;
  // —É–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã, –Ω–µ —Ü–∏—Ñ—Ä—ã –∫—Ä–æ–º–µ .,,- 
  s = s.replace(/\s+/g,'').replace(/,/g,'.').replace(/[^\d.\-]/g,'');
  const n = Number(s);
  return isFinite(n) ? n : NaN;
}
function fmt(n,dec=2){
  if (!isFinite(n)) return '‚Äî';
  // –ª–æ–∫–∞–ª—å-agnostic formatting with grouping
  return n.toLocaleString(undefined,{minimumFractionDigits:dec,maximumFractionDigits:dec});
}

/* ====== –≠–ª–µ–º–µ–Ω—Ç—ã ====== */
const el = id => document.getElementById(id);
const myRateEl = el('myRate');
const clientRateEl = el('clientRate');
const amountEl = el('amount');
const dirRubBtn = el('dir-rub2cny');
const dirCnyBtn = el('dir-cny2rub');
const clientGetEl = el('clientGet');
const clientGiveEl = el('clientGive');
const profitRubEl = el('profitRub');
const profitCnyEl = el('profitCny');
const detailLine = el('detailLine');
const flagRu = el('flag-ru');
const flagCn = el('flag-cn');
const titleEl = el('title');
const subtitleEl = el('subtitle');
const lblYourRate = el('lbl-your-rate');
const lblClientRate = el('lbl-client-rate');
const lblAmount = el('lbl-amount');
const labClientGet = el('lab-client-get');
const labClientGive = el('lab-client-give-label');
const hintLine = el('hint-line');

/* ====== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ====== */
let direction = 'rub2cny'; // —Ä—É–± -> —é–∞–Ω—å (client gives rub)
let currentLang = 'ru';
let lastEdited = null; // 'amount' | 'clientGet' | 'clientGive' | 'myRate' | 'clientRate'
let debounceTimer = null;
let animTimer = null;

/* ====== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏) ====== */
const L = {
  ru: {
    title:'–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞',
    subtitle:'–ë—ã—Å—Ç—Ä—ã–π –∏ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏',
    hint:'–ù–∞–ø—Ä–∏–º–µ—Ä: 11.3 –∏–ª–∏ 0.0884 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞',
    yourRate:'–í–∞—à –∫—É—Ä—Å',
    clientRate:'–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫—É—Ä—Å',
    amount:'–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',
    clientGet:'–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç',
    clientGive:'–ö–ª–∏–µ–Ω—Ç –æ—Ç–¥–∞—Å—Ç',
    profitRub:'–í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å (‚ÇΩ)',
    profitCny:'–í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å (ÂÖÉ)',
    detailsRub:`–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É –∫—É—Ä—Å—É; –≤—ã –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç–µ –ø–æ –≤–∞—à–µ–º—É –∫—É—Ä—Å—É.`,
    detailsCny:`–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ –≤–∞—à–µ–º—É –∫—É—Ä—Å—É; –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º—É –∫—É—Ä—Å—É.`
  },
  cn: {
    title:'ÂÖëÊç¢ËÆ°ÁÆóÂô®',
    subtitle:'Âø´ÈÄü‰∏îÂáÜÁ°ÆÁöÑÂà©Ê∂¶ËÆ°ÁÆó',
    hint:'‰æãÂ¶Ç: 11.3 Êàñ 0.0884 ‚Äî ‰∏§ÁßçÊ†ºÂºèÈÉΩÊîØÊåÅ',
    yourRate:'ÊÇ®ÁöÑÊ±áÁéá',
    clientRate:'ÂÆ¢Êà∑Ê±áÁéá',
    amount:'ËØ∑ËæìÂÖ•ÈáëÈ¢ù',
    clientGet:'ÂÆ¢Êà∑ÂæóÂà∞',
    clientGive:'ÂÆ¢Êà∑ÁªôÂá∫',
    profitRub:'ÊÇ®ÁöÑÂà©Ê∂¶ (‚ÇΩ)',
    profitCny:'ÊÇ®ÁöÑÂà©Ê∂¶ (ÂÖÉ)',
    detailsRub:`ÂÆ¢Êà∑ÊåâÂÆ¢Êà∑Ê±áÁéáÊî∂Âà∞ÔºõÊÇ®ÊåâÊÇ®ÁöÑÊ±áÁéáÂÖëÊç¢„ÄÇ`,
    detailsCny:`ÊÇ®ÊåâÊÇ®ÁöÑÊ±áÁéáÂæóÂà∞ÔºõÂÆ¢Êà∑ÊåâÂÆ¢Êà∑Ê±áÁéáÊî∂Âà∞„ÄÇ`
  }
};

/* ====== UI: –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ ====== */
function applyLang(lang){
  currentLang = lang;
  const t = L[lang];
  titleEl.textContent = t.title;
  subtitleEl.textContent = t.subtitle;
  hintLine.textContent = t.hint;
  lblYourRate.textContent = t.yourRate;
  lblClientRate.textContent = t.clientRate;
  lblAmount.textContent = t.amount;
  labClientGet.textContent = t.clientGet;
  labClientGive.textContent = t.clientGive;
  // active flag visuals
  flagRu.classList.toggle('active', lang==='ru');
  flagCn.classList.toggle('active', lang==='cn');
}
flagRu.addEventListener('click', ()=> applyLang('ru'));
flagCn.addEventListener('click', ()=> applyLang('cn'));
applyLang('ru');

/* ====== Direction toggles ====== */
function setDirection(dir){
  direction = dir;
  dirRubBtn.classList.toggle('active', dir==='rub2cny');
  dirCnyBtn.classList.toggle('active', dir==='cny2rub');
  scheduleRecalc('direction');
}
dirRubBtn.addEventListener('click', ()=> setDirection('rub2cny'));
dirCnyBtn.addEventListener('click', ()=> setDirection('cny2rub'));

/* ====== Convert rate: accept both formats ====== */
function toRubPerCny(rateInput){
  // if input > 1 treated as "rub per 1 cny"
  // if input <= 1 treated as "cny per 1 rub" => convert: rubPerCny = 1 / input
  const v = cleanNum(rateInput);
  if (!isFinite(v) || v === 0) return NaN;
  if (Math.abs(v) > 1) return v; // rub per cny
  return 1 / v; // convert cny-per-rub -> rub-per-cny
}

/* ====== Core calculate function ====== */
function computeAll(){
  // parse rates
  const myRateIn = cleanNum(myRateEl.value);
  const clientRateIn = cleanNum(clientRateEl.value);
  const myRate = toRubPerCny(myRateIn);
  const clientRate = toRubPerCny(clientRateIn);

  // amount interpretation depends on direction:
  // if rub2cny: amount input = rubles client gives
  // if cny2rub: amount input = yuans client gives
  let amountRaw = cleanNum(amountEl.value);

  // invalid rates -> clear
  if (!isFinite(myRate) || !isFinite(clientRate) || myRate<=0 || clientRate<=0){
    // show placeholders
    setDisplay('clientGet','‚Äî');
    setDisplay('clientGive','‚Äî');
    profitRubEl.textContent = '‚Äî';
    profitCnyEl.textContent = '‚Äî';
    detailLine.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫—É—Ä—Å—ã';
    return;
  }

  // Based on lastEdited we might compute amount from clientGet or clientGive
  if (lastEdited === 'clientGet'){
    // user edited clientGet: compute amount needed
    const cg = cleanNum(clientGetEl.textContent);
    if (!isFinite(cg)){ /*invalid*/ }
    else {
      if (direction === 'rub2cny'){
        // clientGet is cny -> client must give rub = clientGet * clientRate
        amountRaw = cg * clientRate;
        amountEl.value = fmt(amountRaw,0);
      } else {
        // cny2rub: clientGet is rub -> amount (cny) = clientGet / clientRate
        amountRaw = cg / clientRate;
        amountEl.value = fmt(amountRaw,2);
      }
    }
  } else if (lastEdited === 'clientGive'){
    // user edited clientGive: set amount directly
    const cg = cleanNum(clientGiveEl.textContent);
    if (isFinite(cg)){
      if (direction === 'rub2cny'){
        amountRaw = cg; // given rub
        amountEl.value = fmt(amountRaw,0);
      } else {
        amountRaw = cg; // given cny
        amountEl.value = fmt(amountRaw,2);
      }
    }
  } else {
    // lastEdited is amount or other -> amountRaw already
  }

  // Now compute general outputs
  if (direction === 'rub2cny'){
    const amountRub = amountRaw;
    if (!isFinite(amountRub)){ setDisplay('clientGet','‚Äî'); setDisplay('clientGive','‚Äî'); return; }
    const clientGetsCny = amountRub / clientRate;
    const myCnyBought = amountRub / myRate;
    const profitCny = myCnyBought - clientGetsCny;
    const profitRub = profitCny * myRate;

    // Update displays
    setDisplay('clientGet', fmt(clientGetsCny,2) + ' ÂÖÉ');
    setDisplay('clientGive', fmt(amountRub,0) + ' ‚ÇΩ'); // clientGive is amount
    profitRubEl.textContent = fmt(profitRub,2) + ' ‚ÇΩ';
    profitCnyEl.textContent = fmt(profitCny,2) + ' ÂÖÉ';
    detailLine.textContent = L[currentLang].detailsRub + ` (${fmt(amountRub,0)} ‚ÇΩ ‚Üí ${fmt(myCnyBought,2)} ÂÖÉ –ø–æ –≤–∞—à–µ–º—É –∫—É—Ä—Å—É ‚Üí –æ—Ç–¥–∞–Ω–æ ${fmt(clientGetsCny,2)} ÂÖÉ)`;

  } else {
    // cny2rub: client gives cny
    const amountCny = amountRaw;
    if (!isFinite(amountCny)){ setDisplay('clientGet','‚Äî'); setDisplay('clientGive','‚Äî'); return; }
    const clientGetsRub = amountCny * clientRate;
    const myRub = amountCny * myRate;
    const profitRub = myRub - clientGetsRub;
    const profitCny = profitRub / myRate;

    setDisplay('clientGet', fmt(clientGetsRub,2) + ' ‚ÇΩ');
    setDisplay('clientGive', fmt(amountCny,2) + ' ÂÖÉ');
    profitRubEl.textContent = fmt(profitRub,2) + ' ‚ÇΩ';
    profitCnyEl.textContent = fmt(profitCny,2) + ' ÂÖÉ';
    detailLine.textContent = L[currentLang].detailsCny + ` (${fmt(amountCny,2)} ÂÖÉ ‚Üí ${fmt(myRub,2)} ‚ÇΩ –ø–æ –≤–∞—à–µ–º—É –∫—É—Ä—Å—É ‚Üí –∫–ª–∏–µ–Ω—Ç—É ${fmt(clientGetsRub,2)} ‚ÇΩ)`;
  }
}

/* ====== Safe setter with animation for editable text nodes ====== */
function setDisplay(id, text){
  const node = (id === 'clientGet') ? clientGetEl : (id === 'clientGive') ? clientGiveEl : null;
  if (!node){
    // other fields just set
    if (id === 'profitRub') profitRubEl.textContent = text;
    return;
  }
  // avoid interfering if user is actively editing this element
  const active = document.activeElement === node;
  if (active) {
    // if user typing, don't clobber; but still update if programmatic change desired
    return;
  }
  // animate: fade out -> change -> fade in
  node.style.transition = 'transform .18s, opacity .18s';
  node.style.opacity = 0.0;
  node.style.transform = 'translateY(6px)';
  clearTimeout(animTimer);
  animTimer = setTimeout(()=>{
    node.textContent = text;
    node.style.opacity = 1;
    node.style.transform = 'translateY(0)';
  },160);
}

/* ====== Event wiring with small debounce ====== */
function scheduleRecalc(source){
  lastEdited = source;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(()=>{ computeAll(); lastEdited = null; }, 120);
}

/* inputs */
myRateEl.addEventListener('input', ()=> scheduleRecalc('myRate'));
clientRateEl.addEventListener('input', ()=> scheduleRecalc('clientRate'));

/* amount input */
amountEl.addEventListener('input', ()=> scheduleRecalc('amount'));
amountEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') scheduleRecalc('amount'); });

/* editable results: detect editing and commit */
function sanitizeEditableText(s){
  // remove letters, keep digits, dot, comma, spaces
  return s.replace(/[^\d,.\-\s]/g,'').trim();
}

clientGetEl.addEventListener('input', (e)=>{
  // sanitize quickly
  clientGetEl.textContent = sanitizeEditableText(clientGetEl.textContent);
  scheduleRecalc('clientGet');
});
clientGiveEl.addEventListener('input', (e)=>{
  clientGiveEl.textContent = sanitizeEditableText(clientGiveEl.textContent);
  scheduleRecalc('clientGive');
});

/* When user focuses an editable field, mark lastEdited so we won't clobber it */
[clientGetEl, clientGiveEl, amountEl, myRateEl, clientRateEl].forEach(node=>{
  node.addEventListener('focus', ()=> lastEdited = node.id === 'amount' ? 'amount' : (node === clientGetEl ? 'clientGet' : (node === clientGiveEl ? 'clientGive' : (node === myRateEl ? 'myRate' : 'clientRate'))));
});

/* clicking outside will recalc */
document.addEventListener('click', (e)=>{
  if (!e.target.closest('.value')) {
    // when user clicks away, ensure clean numbers format
    // normalize editable fields
    // update UI formatting
    finalizeEditable(clientGetEl);
    finalizeEditable(clientGiveEl);
  }
});

/* finalize: format editable number nicely */
function finalizeEditable(node){
  const raw = sanitizeEditableText(node.textContent);
  const n = cleanNum(raw);
  if (!isFinite(n)){ node.textContent = '‚Äî'; return; }
  // decide decimals: if direction rub2cny and node is clientGet -> cny (2 decimals)
  if (node === clientGetEl){
    if (direction === 'rub2cny') node.textContent = fmt(n,2) + ' ÂÖÉ';
    else node.textContent = fmt(n,2) + ' ‚ÇΩ';
  } else if (node === clientGiveEl){
    if (direction === 'rub2cny') node.textContent = fmt(n,0) + ' ‚ÇΩ';
    else node.textContent = fmt(n,2) + ' ÂÖÉ';
  }
  scheduleRecalc(node === clientGetEl ? 'clientGet' : 'clientGive');
}

/* friendly formatting when blurring amount */
amountEl.addEventListener('blur', ()=>{
  const n = cleanNum(amountEl.value);
  if (direction === 'rub2cny'){
    if (isFinite(n)) amountEl.value = fmt(n,0);
  } else {
    if (isFinite(n)) amountEl.value = fmt(n,2);
  }
  scheduleRecalc('amount');
});

/* initialize sample values */
myRateEl.value = '11.3';
clientRateEl.value = '11.8';
amountEl.value = '500000';
computeAll();

/* keyboard support: Enter in editable finalizes */
[clientGetEl, clientGiveEl].forEach(node=>{
  node.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); node.blur(); finalizeEditable(node); }
  });
});

/* initial language selection (Chinese text) */
el('flag-cn').addEventListener('click', ()=> applyLang('cn'));

/* expose for debugging */
window.__calc = {computeAll, setDirection};

/* ensure right labels on language change */
function applyLangButton(lang){
  applyLang(lang);
}
</script>
</body>
</html>
